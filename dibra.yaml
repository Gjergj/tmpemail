secrets:
  adapter: bitwarden
  list:
    HOST_PASSWORD: tmpemail.xyz_secrets/password
    HOST: tmpemail.xyz_secrets/host
    HOST_PORT: tmpemail.xyz_secrets/port
    HOST_USER: tmpemail.xyz_secrets/user

inventory:
  real_vps:
    tmpemail.xyz:
      host: ${HOST}
      user: ${HOST_USER}
      port: ${HOST_PORT}
      password: ${HOST_PASSWORD}
      timeout: 30

tasks:
  - hosts:
      - tmpemail.xyz
    systemd:
      operation: reload
      name: caddy
    systemd:
      operation: reload
      name: postfix
    artifacts:
      - type: put
        content: >-
          tmpemail.xyz {
            header Content-Type text/html
            respond <<HTML
              <html>
                <head><title>tmpemail.xyz</title></head>
                <body><a href="https://tmpemail.xyz">tmpemail.xyz</a></body>
              </html>
              HTML 200
          }
        destination: /etc/caddy/Caddyfile
        constraints:
          force: true
      - type: put
        content: |
          smtp      inet  n       -       y       -       -       smtpd
          # Port 587 (submission with STARTTLS)
          submission inet n       -       y       -       -       smtpd
            -o syslog_name=postfix/submission
            -o smtpd_tls_security_level=encrypt
            -o smtpd_recipient_restrictions=reject

          # Port 465 (implicit TLS)
          smtps     inet  n       -       y       -       -       smtpd
            -o syslog_name=postfix/smtps
            -o smtpd_tls_wrappermode=yes
            -o smtpd_recipient_restrictions=reject
          pickup    unix  n       -       y       60      1       pickup
          cleanup   unix  n       -       y       -       0       cleanup
          qmgr      unix  n       -       n       300     1       qmgr
          tlsmgr    unix  -       -       y       1000?   1       tlsmgr
          rewrite   unix  -       -       y       -       -       trivial-rewrite
          bounce    unix  -       -       y       -       0       bounce
          defer     unix  -       -       y       -       0       bounce
          trace     unix  -       -       y       -       0       bounce
          verify    unix  -       -       y       -       1       verify
          flush     unix  n       -       y       1000?   0       flush
          proxymap  unix  -       -       n       -       -       proxymap
          proxywrite unix -       -       n       -       1       proxymap
          smtp      unix  -       -       y       -       -       smtp
          relay     unix  -       -       y       -       -       smtp
          showq     unix  n       -       y       -       -       showq
          error     unix  -       -       y       -       -       error
          retry     unix  -       -       y       -       -       error
          discard   unix  -       -       y       -       -       discard
          local     unix  -       n       n       -       -       local
          virtual   unix  -       n       n       -       -       virtual
          lmtp      unix  -       -       y       -       -       lmtp
          anvil     unix  -       -       y       -       1       anvil
          scache    unix  -       -       y       -       1       scache
          postlog   unix-dgram n  -       n       -       1       postlogd
        destination: /etc/postfix/master.cf
        constraints:
          force: true
      - type: put
        content: |
          # Basic settings
          myhostname = tmpemail.xyz
          mydomain = tmpemail.xyz
          myorigin = ${mydomain}
          mydestination =
          # Network settings - listen on all interfaces
          inet_interfaces = all
          inet_protocols = ipv4

          # Receive only - disable sending
          default_transport = error
          relay_transport = error
          # Virtual mailbox settings
          virtual_mailbox_domains = /etc/postfix/virtual_domains
          virtual_mailbox_maps = hash:/etc/postfix/virtual_mailbox
          virtual_mailbox_base = /var/mail/vmail
          virtual_uid_maps = static:5000
          virtual_gid_maps = static:5000
          # Use Maildir format
          virtual_mailbox_limit = 0
          virtual_mailbox_limit_maps = hash:/etc/postfix/virtual_mailbox_limit
          virtual_mailbox_limit_override = yes
          mailbox_size_limit = 0
          virtual_mailbox_extended = yes
          # Disable local delivery
          local_transport = error:local delivery disabled
          local_recipient_maps =

          # TLS settings for ports 465 and 587
          smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
          smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
          smtpd_use_tls=yes
          smtpd_tls_security_level=may
          smtpd_recipient_restrictions =
              permit_mynetworks,
              reject_unauth_destination

          # Accept mail for virtual domains
          smtpd_relay_restrictions =
              permit_mynetworks,
              reject_unauth_destination
        destination: /etc/postfix/main.cf
        constraints:
          force: true
      - type: put
        content: |
          tmpemail.xyz OK
        destination: /etc/postfix/virtual_domains
        constraints:
          force: true
      - type: put
        content: |
          redacted@tmpemail.xyz tmpemail.xyz/redacted/
        destination: /etc/postfix/virtual_mailbox
        constraints:
          force: true
          
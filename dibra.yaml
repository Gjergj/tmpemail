secrets:
  adapter: bitwarden
  list:
    HOST_PASSWORD: tmpemail.xyz_secrets/password
    HOST: tmpemail.xyz_secrets/host
    HOST_PORT: tmpemail.xyz_secrets/port
    HOST_USER: tmpemail.xyz_secrets/user

inventory:
  real_vps:
    tmpemail.xyz:
      host: ${HOST}
      user: ${HOST_USER}
      port: ${HOST_PORT}
      password: ${HOST_PASSWORD}
      timeout: 30

tasks:
  - hosts:
      - tmpemail.xyz
    name: caddy
    systemd:
      operation: reload
      name: caddy
    artifacts:
      - type: put
        content: >-
          tmpemail.xyz {
            header Content-Type text/html
            respond <<HTML
              <html>
                <head><title>tmpemail.xyz</title></head>
                <body><a href="https://tmpemail.xyz">tmpemail.xyz</a></body>
              </html>
              HTML 200
          }
        destination: /etc/caddy/Caddyfile
        constraints:
          force: true
  - hosts:
      - tmpemail.xyz
    artifacts:
      - type: put
        source: api/tmpemail-api-linux-amd64
        destination: /root/tmpemail-api
        constraints:
          force: true
          executable: true
      - type: put
        content: |
          #!/bin/bash
          # Script to forward received emails to the API
          # This script reads the email from stdin and posts it to the API
          
          API_URL="http://localhost:8080/receive-email"
          EMAIL_DATA=$(cat)
          
          # Extract basic email headers
          TO=$(echo "$EMAIL_DATA" | grep -m1 "^To:" | sed 's/^To: //')
          FROM=$(echo "$EMAIL_DATA" | grep -m1 "^From:" | sed 's/^From: //')
          SUBJECT=$(echo "$EMAIL_DATA" | grep -m1 "^Subject:" | sed 's/^Subject: //')
          
          # Create JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg to "$TO" \
            --arg from "$FROM" \
            --arg subject "$SUBJECT" \
            --arg raw "$EMAIL_DATA" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{to: $to, from: $from, subject: $subject, raw_email: $raw, timestamp: $timestamp}')
          
          # Post to API
          curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            >> /var/log/tmpemail-forward.log 2>&1
          
          exit 0
        destination: /root/tmpemail-forward.sh
        constraints:
          force: true
          executable: true
      - type: put
        content: |
          smtp      inet  n       -       y       -       -       smtpd
          # Port 587 (submission with STARTTLS)
          submission inet n       -       y       -       -       smtpd
            -o syslog_name=postfix/submission
            -o smtpd_tls_security_level=encrypt
            -o smtpd_recipient_restrictions=reject

          # Port 465 (implicit TLS)
          smtps     inet  n       -       y       -       -       smtpd
            -o syslog_name=postfix/smtps
            -o smtpd_tls_wrappermode=yes
            -o smtpd_recipient_restrictions=reject
          pickup    unix  n       -       y       60      1       pickup
          cleanup   unix  n       -       y       -       0       cleanup
          qmgr      unix  n       -       n       300     1       qmgr
          tlsmgr    unix  -       -       y       1000?   1       tlsmgr
          rewrite   unix  -       -       y       -       -       trivial-rewrite
          bounce    unix  -       -       y       -       0       bounce
          defer     unix  -       -       y       -       0       bounce
          trace     unix  -       -       y       -       0       bounce
          verify    unix  -       -       y       -       1       verify
          flush     unix  n       -       y       1000?   0       flush
          proxymap  unix  -       -       n       -       -       proxymap
          proxywrite unix -       -       n       -       1       proxymap
          smtp      unix  -       -       y       -       -       smtp
          relay     unix  -       -       y       -       -       smtp
          showq     unix  n       -       y       -       -       showq
          error     unix  -       -       y       -       -       error
          retry     unix  -       -       y       -       -       error
          discard   unix  -       -       y       -       -       discard
          local     unix  -       n       n       -       -       local
          virtual   unix  -       n       n       -       -       virtual
          lmtp      unix  -       -       y       -       -       lmtp
          anvil     unix  -       -       y       -       1       anvil
          scache    unix  -       -       y       -       1       scache
          postlog   unix-dgram n  -       n       -       1       postlogd
          
          # Pipe transport to forward emails to API
          tmpemail-forward unix - n n - - pipe
            flags=DRhu user=root argv=/root/tmpemail-forward.sh
        destination: /etc/postfix/master.cf
        constraints:
          force: true
      - type: put
        content: |
          # Basic settings
          myhostname = tmpemail.xyz
          mydomain = tmpemail.xyz
          myorigin = ${mydomain}
          mydestination =
          # Network settings - listen on all interfaces
          inet_interfaces = all
          inet_protocols = ipv4

          # Receive only - disable sending
          default_transport = error
          relay_transport = error
          
          # Virtual domain and mailbox settings
          virtual_mailbox_domains = /etc/postfix/virtual_domains
          virtual_mailbox_maps = hash:/etc/postfix/virtual_mailbox
          virtual_mailbox_base = /var/mail/vmail
          virtual_uid_maps = static:5000
          virtual_gid_maps = static:5000
          
          # BCC specific recipients to API
          recipient_bcc_maps = hash:/etc/postfix/recipient_bcc
          
          # Transport routing for API trigger
          transport_maps = hash:/etc/postfix/transport
          
          # Disable local delivery
          local_transport = error:local delivery disabled
          local_recipient_maps =

          # TLS settings for ports 465 and 587
          smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
          smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
          smtpd_use_tls=yes
          smtpd_tls_security_level=may
          smtpd_recipient_restrictions =
              permit_mynetworks,
              reject_unauth_destination

          # Accept mail for virtual domains
          smtpd_relay_restrictions =
              permit_mynetworks,
              reject_unauth_destination
        destination: /etc/postfix/main.cf
        constraints:
          force: true
      - type: put
        content: |
          tmpemail.xyz OK
        destination: /etc/postfix/virtual_domains
        constraints:
          force: true
      - type: put
        content: |
          # Only accept test_123@tmpemail.xyz and store in mailbox
          test_123@tmpemail.xyz tmpemail.xyz/test_123/
        destination: /etc/postfix/virtual_mailbox
        constraints:
          force: true
      - type: command
        command: postmap /etc/postfix/virtual_mailbox
      - type: put
        content: |
          # BCC test_123 to API trigger
          test_123@tmpemail.xyz api-trigger@tmpemail.xyz
        destination: /etc/postfix/recipient_bcc
        constraints:
          force: true
      - type: command
        command: postmap /etc/postfix/recipient_bcc
      - type: put
        content: |
          # Route API trigger to pipe transport
          api-trigger@tmpemail.xyz tmpemail-forward:
        destination: /etc/postfix/transport
        constraints:
          force: true
      - type: command
        command: postmap /etc/postfix/transport
  - hosts:
      - tmpemail.xyz
    systemd:
      operation: reload
      name: postfix